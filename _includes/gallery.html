{%- assign gid = include.id | default: page.gallery | default: page.gallery_id -%}
{%- if gid -%}
  {%- assign g = site.data[gid] -%}
  {%- if g -%}
    {%- comment -%} Normalize: a single section or an array of sections {%- endcomment -%}
    {%- if g.images -%}
      {%- assign sections = [ g ] -%}
    {%- else -%}
      {%- assign sections = g -%}
    {%- endif -%}

    {%- assign gcount = 0 -%}
    {%- comment -%} global counter to mark first 3 eager {%- endcomment -%}

    <div class="columns is-multiline is-variable is-2">
      {%- for section in sections -%}
        {%- if section.title -%}
          <div class="column is-12"><h3 class="title is-5">{{ section.title }}</h3></div>
        {%- endif -%}

        {%- for img in section.images -%}
          {%- assign ratio = img.ratio | default: 'is-16by9' -%}

          {%- assign link = img.link -%}
          {%- if link and link != '' and link | slice: 0,1 != '/' and link contains '://' == false -%}
            {%- assign link = '/' | append: link -%}
          {%- endif -%}

          {%- assign large_link = img.large_link | default: link -%}

          {%- comment -%} Accessible alt: prefer explicit alt, else caption, else filename {%- endcomment -%}
          {%- assign alt = img.alt | default: img.caption -%}
          {%- if alt == nil or alt == '' -%}
            {%- assign alt = link | split:'/' | last | replace:'-',' ' | replace:'_',' ' | split:'.' | first -%}
          {%- endif -%}

          {%- assign sidx = forloop.parentloop.index | default: 1 -%}
          {%- assign iidx = forloop.index -%}
          {%- assign uid = gid | append: '-' | append: sidx | append: '-' | append: iidx -%}

          {%- assign is_eager = false -%}
          {%- if gcount < 3 -%}{%- assign is_eager = true -%}{%- endif -%}

          <div class="column is-one-third">
            <figure class="image {{ ratio }}">
              <a href="#lb-{{ uid }}" class="gallery-item" aria-label="Open image {{ iidx }} in lightbox">
                <div class="preview-container" style="width:100%; height:100%;">
                  <img
                    src="{{ link | relative_url }}"
                    alt="{{ alt | escape }}"
                    {% if is_eager %}loading="eager" decoding="sync" fetchpriority="high"{% endif %}>
                  <div class="hover-effect">Click to view</div>
                </div>
              </a>
            </figure>

            <div id="lb-{{ uid }}" class="lightbox" markdown="0" aria-hidden="true">
              <a href="#!" class="lightbox-close" aria-label="Close image"></a>
              <img src="{{ large_link | relative_url }}" alt="{{ alt | escape }}" decoding="async">
            </div>

            {%- if img.caption or img.description -%}
              <figcaption class="content is-small" style="margin-top:.4rem;">
                {{ img.caption | default: img.description | markdownify }}
              </figcaption>
            {%- endif -%}
          </div>

          {%- assign gcount = gcount | plus: 1 -%}
        {%- endfor -%}
      {%- endfor -%}
    </div>
  {%- else -%}
    <p><em>Gallery “{{ gid }}” not found in <code>_data/</code>.</em></p>
  {%- endif -%}
{%- endif -%}
